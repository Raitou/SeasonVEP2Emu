using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Common;
using System.Data;
using libcomservice.Data;
using libcomservice.Request;
using libcomservice.Core;

namespace libcomservice.REQUEST
{
    public class VerifyAccount
    {
        public void Login(Session p, PacketRead r)
        {
            //33 = +1
            //1249 - normal
            try
            {
                byte[] Crc32 = new byte[] { 0x43, 0x7D, 0x7A, 0x7A };
                int m_dwOK = 0;
                p.PInfo.m_strLogin = r.String();
                p.PInfo.m_strPasswd = r.String();
                p.PInfo.m_bMale = r.Bool();
                p.PInfo.m_iVersion = r.Int();
                r.Int();
                byte[] checksum = r.Buffer_Array_Bytes(4);
                //Log.WriteHex("Checksum:",checksum);

                PacketWrite pw = new PacketWrite();

                Log.Write("clog : KTRUser::KSkTRUser::CheckLogin::User {0} and Passwd {1}", p.PInfo.m_strLogin, p.PInfo.m_strPasswd);
                int Login_Acess = Querys.Execute_VerifyAccount(p, p.PInfo.m_strLogin, p.PInfo.m_strPasswd);
                if (Login_Acess == 0)
                {
                    p.Req.ExpTable(p);
                    p.Req.ServerTime(p);
                    p.Req.NewCharChoice(p);
                    p.PCharacters.LoadCharacters(p.PInfo.m_strLogin, p.PInfo.m_dwUserUID);                    
                    p.PStages.LoadStages(p);
                    p.PInventory.InventoryItens(p);
                    p.PLetter.LoadLetter(p.PInfo.m_dwUserUID);
                    Log.Write("clog : KTRUser::KSkTRUser::OnClientLoginOK(), {0}-{1}-{2}.", DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
                }
                else if (Login_Acess == 14)
                {
                    m_dwOK = 7;
                }
                if (checksum != Crc32)
                { 
                    m_dwOK = 10;
                }
                pw.UnicodeStr(p.PInfo.m_strLogin);
                pw.UnicodeStr(p.PInfo.m_strNickName);
                pw.Int(0);
                pw.Str(p.PInfo.m_strPasswd);                
                pw.HexArray("00 2E 00 37 00 32 00 31 00 00 C8 72 D1 BF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00");
                pw.Byte(0);//m_cAuthLevel
                pw.Int(100);//m_iAge
                pw.Bool(false);//m_bAgreePrivateInfo
                pw.Byte(0);//m_cPCBangType
                Serializables.m_mapCharacterInfo(p, pw);
                pw.UShort(GameServer.m_usUdpPort);
                pw.Int(p.PInfo.m_dwUserUID);
                pw.UnicodeStr(GameServer.m_strServerName);
                pw.Int(GameServer.m_iSessionInfo);             
                pw.HexArray("00 00 00 00");
                Serializables.SerializeStages(p, pw);
                pw.UInt(3222798336);//C0 18 00 00 //m_nConnectType
                Serializables.m_vecMissionSlot(p, pw);
                pw.Int(0);
                pw.HexArray("29 E1 85 22 02 00 74 85 00 00 00 01 00 00 00 00 00 00 00 00");
                pw.UnicodeStr("MsgServer_02");
                pw.Str(GameServer.m_dwIP);
                pw.UShort(GameServer.m_usMsgPort);
                pw.HexArray("00 00 02 9D 00 00 00 00 00 00 00 00 FF FF FF FF FF FF FF FF");
                pw.Str(GameServer.m_dwIP);
                pw.HexArray("00 00 00 00 00 00 00 00 03 5A 35 55 C0 5A 35 55 C0 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 01 00 00 00 01 61 D0 5E 60 00 D0 FF F9 3D AC 0C F9 74 00 5A 35 55 00 00 00 00 00 73 E6 5F 5A 33 2C A0 00 00 00 00");
                //Chars
                pw.HexArray("00 00 00 15 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 05 00 00 00 05 00 00 00 00 00 00 00 00 00 00 00 00 00 06 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 00 00 07 00 00 00 07 00 00 00 00 00 00 00 00 00 00 00 00 00 08 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 09 00 00 00 09 00 00 00 00 00 00 00 00 00 00 00 00 00 0A 00 00 00 0A 00 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 00 0B 00 00 00 00 00 00 00 00 00 00 00 00 00 0C 00 00 00 0C 00 00 00 00 00 00 00 00 00 00 00 00 00 0D 00 00 00 0D 00 00 00 00 00 00 00 00 00 00 00 00 00 0E 00 00 00 0E 00 00 00 00 00 00 00 00 00 00 00 00 00 0F 00 00 00 0F 00 00 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 11 00 00 00 11 00 00 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00 12 00 00 00 00 00 00 00 00 00 00 00 00 00 13 00 00 00 13 00 00 00 00 00 00 00 00 00 00 00 00 00 14 00 00 00 14 00 00 00 00 00 00 00 00 00 00");
                pw.HexArray("00 00 00 03 00 00 00 C6 00 0C 22 CC 00 00 00 00 00 00 00 C7 00 0C F1 FC 00 00 00 00 00 00 00 C9 00 15 6D 0A 00 00 00 01");
                pw.Int(p.PInfo.m_dwSlots);
                pw.Byte(255);
                pw.Byte(0);
                pw.Byte(0);
                p.SendPacket(pw, 34);
                p.Shop.SendMyVirtualCash(p);
                p.HeroDugeons.HeroDungeonInfo(p);
                UdpPort(p);
                sends(p);
            }
            catch (Exception Ex)
            {
                Log.Write("{0} \n\n {1}", Ex.Message, Ex.StackTrace);
            }
        }

        private void sends(Session p)
        {
            mee(p, 417, "5A 35 55 AC 00 00 07 E1 00 00 00 0C 00 00 00 10 00 00 00 0F 00 00 00 13 00 00 00 28");
            mee(p, 1248, "00 00 00 09 00 00 00 43 00 00 00 43 00 00 00 01 00 12 F5 AC 00 00 00 01 00 00 00 01 00 0A 1E 46 00 00 00 01 00 00 00 44 00 00 00 44 00 00 00 01 00 0B 62 4C 00 00 00 01 00 00 00 00 00 00 00 45 00 00 00 45 00 00 00 01 00 12 F5 AC 00 00 00 01 00 00 00 01 00 0A 1E 46 00 00 00 01 00 00 00 47 00 00 00 47 00 00 00 01 00 0C 52 D8 00 00 00 01 00 00 00 01 00 0C 55 1C 00 00 00 01 00 00 00 48 00 00 00 48 00 00 00 01 00 12 F5 AC 00 00 00 01 00 00 00 00 00 00 00 4B 00 00 00 4B 00 00 00 01 00 0F 89 E4 00 00 00 01 00 00 00 00 00 00 00 52 00 00 00 52 00 00 00 01 00 11 1C 5A 00 00 00 01 00 00 00 00 00 00 00 53 00 00 00 53 00 00 00 01 00 12 F5 AC 00 00 00 01 00 00 00 00 00 00 00 6A 00 00 00 6A 00 00 00 01 00 17 D5 72 00 00 00 01 00 00 00 00");
            mee(p, 1584, "00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 10 00 00 00 00 00 00 00 00");
            mee(p, 1411, "00 00 00 12 00 0F 1D E2 00 0F 1D E2 00 00 00 00 00 00 0F 1D EC 00 0F 1D EC 01 00 00 00 00 00 0F 1D F6 00 0F 1D F6 02 00 00 00 00 00 0F 1E 00 00 0F 1E 00 03 00 00 00 02 00 07 C2 FE 00 07 C3 08 00 0F 1E 0A 00 0F 1E 0A 04 00 00 00 03 00 07 C3 12 00 07 C3 1C 00 07 C3 26 00 0F 1E 14 00 0F 1E 14 05 00 00 00 02 00 07 C2 EA 00 07 C2 F4 00 0F 1E 1E 00 0F 1E 1E 06 00 00 00 03 00 07 C3 76 00 07 C3 80 00 07 C3 8A 00 0F 1E 28 00 0F 1E 28 07 00 00 00 03 00 07 C3 44 00 07 C3 4E 00 07 C3 58 00 0F 1E 32 00 0F 1E 32 08 00 00 00 00 00 0F 1E 3C 00 0F 1E 3C 09 00 00 00 03 00 07 C3 DA 00 07 C3 E4 00 07 C3 EE 00 0F 1E 46 00 0F 1E 46 0A 00 00 00 03 00 07 C4 0C 00 07 C4 16 00 07 C4 20 00 0F 1E 50 00 0F 1E 50 0B 00 00 00 03 00 07 C4 3E 00 07 C4 48 00 07 C4 52 00 0F 1E 5A 00 0F 1E 5A 0C 00 00 00 03 00 08 04 80 00 08 04 8A 00 08 04 94 00 0F 1E 64 00 0F 1E 64 0D 00 00 00 00 00 0F 1E 6E 00 0F 1E 6E 0E 00 00 00 00 00 0F 1E 78 00 0F 1E 78 0F 00 00 00 00 00 0F 1E 82 00 0F 1E 82 10 00 00 00 00 00 12 DF FE 00 12 DF FE 11 00 00 00 00");
            mee(p, 1649, "00 00 00 00 00 00 00 00 0B 00 00 00 00 03 00 00 00 00 00 01 48 F0 B6 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 48 F0 B6 00 00 00 46 00 00 00 00 00 00 00 8C 00 00 00 A0 00 00 00 01 00 00 00 00 00 00 00 00 00 01 48 F0 B6 00 00 00 00 01 48 F0 B6 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 2C 00 00 01 2C 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 07 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF 00 00 00 00 00 00 00 07 D0 00 00 07 D0 00 00 00 0A 00 00 00 00 00 00 00 5A 00 00 00 64 00 00 00 00 00 00 00 00 00 00 00 22 00 00 00 00 03 00 00 00 28 00 00 00 00 00 00 00 01 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 07 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 08 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 09 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0A 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0C 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0D 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0E 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0F 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 11 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 13 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 14 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 15 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 16 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 17 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 18 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 19 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 1A 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 1B 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 1E 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 24 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 27 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 28 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 2A 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 2B 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 2C 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 2D 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 2E 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 2F 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 30 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 31 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 32 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 33 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 34 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 35 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 36 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0F 00 06 CF E8 00 00 00 00 00 D9 04 96 FF FF FF FF FF FF FF FF 00 00 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 D2 5E 00 00 00 00 00 D9 04 98 FF FF FF FF FF FF FF FF 00 00 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F8 92 00 00 00 00 00 D9 04 99 FF FF FF FF FF FF FF FF 00 02 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 09 01 40 00 00 00 01 01 01 43 25 00 00 02 0A 01 3E 87 2B 02 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F8 9C 00 00 00 00 00 D9 04 9A FF FF FF FF FF FF FF FF 00 01 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 09 01 40 00 00 00 01 08 01 40 98 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F8 B0 00 00 00 00 00 D9 04 9B FF FF FF FF FF FF FF FF 00 01 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 08 01 40 98 00 00 01 09 01 40 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F8 A6 00 00 00 00 00 D9 04 9C FF FF FF FF FF FF FF FF 00 02 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 03 01 44 10 40 00 01 02 01 43 25 00 00 02 00 01 43 A9 80 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 12 C8 F2 00 00 00 00 00 D9 04 9E 00 00 00 0A 00 00 00 0A 00 00 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 0F 44 7A 00 00 00 00 00 D9 04 9F 00 00 00 01 00 00 00 01 00 02 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F7 20 00 00 00 00 00 D9 04 A0 FF FF FF FF FF FF FF FF 00 01 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 02 00 00 00 02 00 00 01 43 BA 00 00 01 02 01 43 3C 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F7 2A 00 00 00 00 00 D9 04 A1 FF FF FF FF FF FF FF FF 00 01 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 02 00 00 00 02 00 08 01 40 A6 66 66 01 03 01 44 1E 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F7 34 00 00 00 00 00 D9 04 A2 FF FF FF FF FF FF FF FF 00 01 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 02 00 00 00 02 00 04 01 43 BB 80 00 01 09 01 40 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F7 3E 00 00 00 00 00 D9 04 A3 FF FF FF FF FF FF FF FF 00 02 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 02 00 00 00 00 01 02 00 00 00 03 00 03 01 44 1E 00 00 01 1C 01 41 AC 66 66 02 00 01 43 BA 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 F7 48 00 00 00 00 00 D9 04 A5 FF FF FF FF FF FF FF FF 00 01 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 02 00 00 00 02 00 01 01 43 3C 00 00 01 0C 01 40 1A E1 48 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 06 ED D4 00 00 00 00 00 D9 04 A7 FF FF FF FF FF FF FF FF 00 01 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 02 00 00 00 02 00 01 01 43 3C 00 00 01 02 01 43 3C 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 13 0B 96 00 00 00 00 00 D9 04 A8 00 00 00 01 00 00 00 01 00 02 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 01 58 73 0D 0B 62 4F D0 00 00 0B 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00");
            //mee(p, 0, "");
        }

        private void mee(Session p,int opcode, string payload)
        {
            PacketWrite pw = new PacketWrite();
            pw.HexArray(payload);
            p.SendPacket(pw, (short)opcode);
        }

        private void UdpPort(Session p)
        {
            PacketWrite pw = new PacketWrite();
            pw.HexArray("66 95");
            p.SendPacket(pw, 143);
            p.SendPacket(pw, 142);
        }
    }
}
